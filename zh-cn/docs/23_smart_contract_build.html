<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="23_smart_contract_build" />
	<meta name="description" content="23_smart_contract_build" />
	<!-- 网页标签标题 -->
	<title>23_smart_contract_build</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><div class="search search-normal"><span class="icon-search"></span></div><span class="language-switch language-switch-normal">En</span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal menu-item-normal-active"><a href="/zh-cn/docs/00_index.html" target="_self">文档</a></li></ul></div></div></header><div class="bar"><div class="bar-body"><img src="/img/system/docs.png" class="front-img"/><span>文档</span><img src="/img/system/docs.png" class="back-img"/></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span>认识比原</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/00_index.html" target="_self">概述</a></li><li style="height:288px;overflow:hidden" class="menu-item menu-item-level-2"><span>设计原理和架构<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/13_architecture_overview.html" target="_self">整体架构概览</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/14_key.html" target="_self">秘钥</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/15_address.html" target="_self">地址</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/16_account.html" target="_self">账户</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/17_transaction.html" target="_self">交易</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/18_block.html" target="_self">区块</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/19_utxo.html" target="_self">UTXO</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/20_consensus.html" target="_self">共识算法</a></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>智能合约<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/22_smart_contract_overview.html" target="_self">概述</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/23_smart_contract_build.html" target="_self">构造流程</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/24_contract_operator.html" target="_self">操作符介绍</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/25_contract_template.html" target="_self">合约模板</a></li></ul></li><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>侧链<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/30_sidechain_overview.html" target="_self">概述</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/31_sidechain.html" target="_self">配置节点</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>开发者指南</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/06_build_environment.html" target="_self">搭建开发环境</a></li><li style="height:108px;overflow:hidden" class="menu-item menu-item-level-2"><span>编译运行全节点<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/07_compile_and_run_node.html" target="_self">安装与运行</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/demo2.html" target="_self">docker运行比原全节点</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/08_rpc_call.html" target="_self">全节点RPC接口调用</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/09_ws_call.html" target="_self">Websocket使用说明</a></li></ul></li><li class="menu-item menu-item-level-1"><span>快速学习</span><ul><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>DAPP开发指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dapp/1_dapp.html" target="_self">安装与运行</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dapp/2_dapp.html" target="_self">配置节点</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/dapp/3_dapp.html" target="_self">命令行工具</a></li></ul></li><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>开发资料集合<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/collection/1_collection.html" target="_self">文档</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/collection/2_collection.html" target="_self">配置节点</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/collection/3_collection.html" target="_self">命令行工具</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>对接指南</span><ul><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>交易所对接指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/exchange/1_exchange.html" target="_self">安装与运行</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/exchange/2_exchange.html" target="_self">配置节点</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/exchange/3_exchange.html" target="_self">配置节点</a></li></ul></li><li style="height:144px;overflow:hidden" class="menu-item menu-item-level-2"><span>钱包所对接指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/wallet/1_wallet.html" target="_self">安装与运行</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/wallet/2_wallet.html" target="_self">配置节点</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/wallet/3_wallet.html" target="_self">开始挖矿</a></li></ul></li></ul></li><li class="menu-item menu-item-level-1"><span>SDK集锦</span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/10_other_sdk.html" target="_self">第三方SDK</a></li></ul></li><li class="menu-item menu-item-level-1"><span>生态圈</span><ul><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>比原生态<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/26_wallet.html" target="_self">全节点钱包</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/27_ligth_wallet.html" target="_self">轻钱包</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/28_block_explorer.html" target="_self">区块链浏览器</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/29_mining_pool.html" target="_self">矿池</a></li></ul></li><li style="height:72px;overflow:hidden" class="menu-item menu-item-level-2"><span>落地应用<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/application/1_application.html" target="_self">应用</a></li></ul></li></ul></li></ul></div><div class="doc-content markdown-body"><h2>合约交易构造流程</h2>
<h3>合约参数构造</h3>
<p>合约参数主要包括两个方面，一个是编译合约<code>contract</code>中的参数，另一个是解锁合约<code>clause</code>中的参数。其中参数的相关注意事项如下：</p>
<ul>
<li>调用编译合约API接口<code>compile</code>不加参数是直接编译合约，按照<code>contract</code>中的参数列表顺序加上参数是将合约实例化</li>
<li>构造解锁合约交易需要添加<code>clause</code>中的参数列表</li>
<li><code>Signature</code>参数类型只能在<code>clause</code>的参数列表中出现，不允许出现在<code>contract</code>的参数列表中</li>
<li>如果合约包含多个<code>clause</code>，那么用户只需选择任意一个<code>clause</code>来解锁就可以了。在构造解锁合约的交易过程中，需要添加额外的参数<code>clause_selector</code>（无符号整数类型，小端存储格式），<code>clause_selector</code>是根据合约<code>clause</code>的顺序来指定的，假如<code>clause</code>的个数<code>n</code>，那么选择对应的<code>clause_selector</code>为<code>0 ~ n-1</code>，即第一个<code>clause</code>的<code>clause_selector</code>为<code>0</code>，第二个<code>clause</code>的<code>clause_selector</code>为<code>1</code>，以此类推。</li>
</ul>
<p>如果合约的<code>clause</code>参数列表中包含<code>Signature</code>，那么在构造解锁合约交易的时候需要通过签名的必要条件<code>root_xpub</code>和<code>derivation_path</code>来间接获得，因为签名必须通过调用<code>sign-transaction</code>API接口才能得到。参数<code>root_xpub</code>和<code>derivation_path</code>是通过调用<code>list-pubkeys</code>接口获取的，此外<code>Signature</code>一般需要跟<code>PublicKey</code>配套使用，即参数<code>root_xpub</code>和<code>derivation_path</code>需要跟公钥<code>pubkey</code>一一对应，否则合约会执行失败。</p>
<p>其中<a href="https://github.com/Bytom/bytom/wiki/API-Reference#list-pubkeys">API接口<code>list-pubkeys</code></a>的参数如下：</p>
<ul>
<li><code>String</code> - <em>account_id</em>, 账户ID.</li>
<li><code>String</code> - <em>account_alias</em>, 账户别名.</li>
<li><code>String</code> - <em>public_key</em>, 根据指定pubkey来查询.</li>
</ul>
<p>其请求和响应的json格式如下：</p>
<pre><code class="language-js"><span class="hljs-comment">// Request</span>
{
  <span class="hljs-string">"account_id"</span>: <span class="hljs-string">"0G1JIR6400A02"</span>
}

<span class="hljs-comment">// Result</span>
{
  <span class="hljs-string">"pubkey_infos"</span>: [
    {
      <span class="hljs-string">"derivation_path"</span>: [
        <span class="hljs-string">"010100000000000000"</span>,
        <span class="hljs-string">"0300000000000000"</span>
      ],
      <span class="hljs-string">"pubkey"</span>: <span class="hljs-string">"c37d5531f393bc6a3568628c0c0e17801ea452e75d604deb01403c4b161659a3"</span>
    },
    {
      <span class="hljs-string">"derivation_path"</span>: [
        <span class="hljs-string">"010100000000000000"</span>,
        <span class="hljs-string">"0200000000000000"</span>
      ],
      <span class="hljs-string">"pubkey"</span>: <span class="hljs-string">"117d12e84bb19e956451e0b1eb2bffc662ecb7aac7e63d77e524ddd467eb3617"</span>
    },
    {
      <span class="hljs-string">"derivation_path"</span>: [
        <span class="hljs-string">"010100000000000000"</span>,
        <span class="hljs-string">"0100000000000000"</span>
      ],
      <span class="hljs-string">"pubkey"</span>: <span class="hljs-string">"e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e78"</span>
    }
  ],
  <span class="hljs-string">"root_xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>
}
</code></pre>
<hr>
<h3>编译合约</h3>
<p>编译合约是将合约编译成可执行的虚拟机指令流程。如果合约有参数列表<code>contract parameters</code>的话，在锁定合约之前需要对这些合约参数进行实例化，因为这些参数是解锁合约的限制条件。</p>
<p>编译合约目前支持两种方式，一种是使用<code>equity</code>编译工具，另一种是调用编译合约的API接口<code>compile</code>。其中通过<a href="https://github.com/Bytom/equity"><code>equity</code>编译工具</a>的方式如下：</p>
<pre><code>./equity &lt;contract_file&gt; [flags]
</code></pre>
<p>其中<code>flag</code>标志如下：</p>
<pre><code>    --bin        Binary of the contracts in hex.
    --instance   Object of the Instantiated contracts.
    --shift      Function shift of the contracts.
</code></pre>
<p>以<code>LockWithPublicKey</code>为例，编译并实例化合约如下：</p>
<pre><code>./equity LockWithPublicKey --instance e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e78
</code></pre>
<p>返回结果如下：</p>
<pre><code>======= LockWithPublicKey =======
Instantiated program:
20e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c0
</code></pre>
<p>另一种是通过调用编译合约<a href="https://github.com/Bytom/bytom/wiki/API-Reference#compile">API接口<code>compile</code></a>的方式，其接口参数如下：</p>
<ul>
<li><code>String</code> - <em>contract</em>, 合约内容.</li>
<li><code>Array of Object</code> - <em>args</em>, 合约参数结构体（数组类型）.
<ul>
<li><code>Boolean</code> - <em>boolean</em>, 布尔类型的合约参数，对应的基本类型是<code>Boolean</code>.</li>
<li><code>Integer</code> - <em>integer</em>, 整数类型的合约参数，对应的基本类型包括：<code>Integer</code>、<code>Amount</code>.</li>
<li><code>String</code> - <em>string</em>, 字符串类型的合约参数，对应的基本类型包括：<code>String</code>、<code>Asset</code>、<code>Hash</code>、<code>Program</code>、<code>PublicKey</code>.</li>
</ul>
</li>
</ul>
<p>以<code>LockWithPublicKey</code>为例，其请求和响应的json格式如下：</p>
<pre><code class="language-js"><span class="hljs-comment">// Request</span>
{
  <span class="hljs-string">"contract"</span>: <span class="hljs-string">"contract LockWithPublicKey(publicKey: PublicKey) locks valueAmount of valueAsset { clause unlockWithSig(sig: Signature) { verify checkTxSig(publicKey, sig) unlock valueAmount of valueAsset }}"</span>,
  <span class="hljs-string">"args"</span>: [
    {
      <span class="hljs-string">"string"</span>: <span class="hljs-string">"e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e78"</span>
    }
  ]
}

<span class="hljs-comment">// Result</span>
{
  <span class="hljs-string">"name"</span>: <span class="hljs-string">"LockWithPublicKey"</span>,
  <span class="hljs-string">"source"</span>: <span class="hljs-string">"contract LockWithPublicKey(publicKey: PublicKey) locks valueAmount of valueAsset { clause unlockWithSig(sig: Signature) { verify checkTxSig(publicKey, sig) unlock valueAmount of valueAsset }}"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"20e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c0"</span>,
  <span class="hljs-string">"params"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"publicKey"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"PublicKey"</span>
    }
  ],
  <span class="hljs-string">"value"</span>: <span class="hljs-string">"locked"</span>,
  <span class="hljs-string">"clause_info"</span>: [
    {
      <span class="hljs-string">"name"</span>: <span class="hljs-string">"unlockWithSig"</span>,
      <span class="hljs-string">"args"</span>: [
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"sig"</span>,
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"Signature"</span>
        }
      ],
      <span class="hljs-string">"value_info"</span>: [
        {
          <span class="hljs-string">"name"</span>: <span class="hljs-string">"locked"</span>
        }
      ],
      <span class="hljs-string">"block_heights"</span>: [],
      <span class="hljs-string">"hash_calls"</span>: <span class="hljs-literal">null</span>
    }
  ],
  <span class="hljs-string">"opcodes"</span>: <span class="hljs-string">"0xe9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e78 DEPTH 0xae7cac FALSE CHECKPREDICATE"</span>,
  <span class="hljs-string">"error"</span>: <span class="hljs-string">""</span>
}
</code></pre>
<hr>
<h3>锁定合约</h3>
<p><code>lock</code>锁定合约，即部署合约，其本质是调用<code>build-transaction</code>接口将资产发送到合约特定的<code>program</code>，只需将接收方<code>control_program</code>设置为指定合约即可，构造锁定合约交易的模板如下：（注意：合约交易暂时不支持接收方资产为BTM资产的交易）</p>
<pre><code class="language-js"><span class="hljs-comment">// Request</span>
{
  <span class="hljs-string">"base_transaction"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-string">"actions"</span>: [
    {
      <span class="hljs-string">"account_id"</span>: <span class="hljs-string">"0G1JIR6400A02"</span>,
      <span class="hljs-string">"amount"</span>: <span class="hljs-number">20000000</span>,
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"spend_account"</span>
    },
    {
      <span class="hljs-string">"account_id"</span>: <span class="hljs-string">"0G1JIR6400A02"</span>,
      <span class="hljs-string">"amount"</span>: <span class="hljs-number">900000000</span>,
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c22"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"spend_account"</span>
    },
    {
      <span class="hljs-string">"amount"</span>: <span class="hljs-number">900000000</span>,
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c22"</span>,
      <span class="hljs-string">"control_program"</span>: <span class="hljs-string">"20e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c0"</span>,
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"control_program"</span>
    }
  ],
  <span class="hljs-string">"ttl"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"time_range"</span>: <span class="hljs-number">1521625823</span>
}

<span class="hljs-comment">// Result</span>
{
  <span class="hljs-string">"raw_transaction"</span>: <span class="hljs-string">"0701dfd5c8d505020161015f150ec246dc739a8c4c3f7b4083ededcb2854ca221e437a49f23ec84c7c47ea80ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8099c4d599010001160014726e902e30525e01f0157f12be476c904060383b01000160015ed53c1f3388681f62ae778ac8a54c2b091bbdc91d68ec1e94b20aa2183484f8331e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c2280c8afa02501011600145de3c504b41019d11698d572b1a37d9a4c9118c1010003013effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff80bfffcb990101160014310c2265e8e3b7057a62caf09a9f907763f369ea00013d1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c2280f69bf32101160014d0d18752a276c94b25f920b02a8edff251b16b7600014f1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c2280d293ad03012820e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c000"</span>,
  <span class="hljs-string">"signing_instructions"</span>: [
    {
      <span class="hljs-string">"position"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"witness_components"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
          <span class="hljs-string">"quorum"</span>: <span class="hljs-number">1</span>,
          <span class="hljs-string">"keys"</span>: [
            {
              <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
              <span class="hljs-string">"derivation_path"</span>: [
                <span class="hljs-string">"010100000000000000"</span>,
                <span class="hljs-string">"0100000000000000"</span>
              ]
            }
          ],
          <span class="hljs-string">"signatures"</span>: <span class="hljs-literal">null</span>
        },
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"data"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e78"</span>
        }
      ]
    },
    {
      <span class="hljs-string">"position"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"witness_components"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
          <span class="hljs-string">"quorum"</span>: <span class="hljs-number">1</span>,
          <span class="hljs-string">"keys"</span>: [
            {
              <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
              <span class="hljs-string">"derivation_path"</span>: [
                <span class="hljs-string">"010100000000000000"</span>,
                <span class="hljs-string">"0700000000000000"</span>
              ]
            }
          ],
          <span class="hljs-string">"signatures"</span>: <span class="hljs-literal">null</span>
        },
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"data"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"54df681ac3174a11d4456265641a204e04f64b8f860f37bf5584cf4187f54e99"</span>
        }
      ]
    }
  ],
  <span class="hljs-string">"allow_additional_actions"</span>: <span class="hljs-literal">false</span>
}
</code></pre>
<p>构建交易成功之后，便可以对交易进行签名<code>sign-transaction</code>，返回结果中<code>sign_complete</code>为<code>true</code>表示签名成功，将签名的交易通过<code>submit-transaction</code>提交到交易池中，等待交易被打包上链</p>
<hr>
<h3>查找合约UTXO</h3>
<p>部署合约交易发送成功之后，接下来便需要对合约锁定的资产进行解锁，解锁合约之前需要找到合约的UTXO。</p>
<p>可以通过调用<a href="https://github.com/Bytom/bytom/wiki/API-Reference#list-unspent-outputs">API接口<code>list-unspent-outputs</code></a>来查找，在查合约UTXO的情况下必须将<code>smart_contract</code>设置为<code>true</code>，否则会查不到，其参数如下：</p>
<ul>
<li><code>String</code> - <em>id</em>, UTXO对应的<code>outputID</code>，可以根据发布合约交易的输出<code>output</code>中的找到.</li>
<li><code>Boolean</code> - <em>smart_contract</em>, 是否展示合约的UTXO，默认不显示.</li>
</ul>
<p>对应的输入输出结果如下：</p>
<pre><code class="language-js"><span class="hljs-comment">// Request</span>
curl -X POST list-unspent-outputs -d <span class="hljs-string">'{"id": "413d941faf5a19501ab4c06747fe1eb38c5ae76b74d0f5af524fc40ee6bf7116", "smart_contract": true}'</span>

<span class="hljs-comment">// Result</span>
{
  <span class="hljs-string">"account_alias"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"account_id"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"address"</span>: <span class="hljs-string">""</span>,
  <span class="hljs-string">"amount"</span>: <span class="hljs-number">900000000</span>,
  <span class="hljs-string">"asset_alias"</span>: <span class="hljs-string">"GOLD"</span>,
  <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c22"</span>,
  <span class="hljs-string">"change"</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">"control_program_index"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"id"</span>: <span class="hljs-string">"413d941faf5a19501ab4c06747fe1eb38c5ae76b74d0f5af524fc40ee6bf7116"</span>,
  <span class="hljs-string">"program"</span>: <span class="hljs-string">"20e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c0"</span>,
  <span class="hljs-string">"source_id"</span>: <span class="hljs-string">"c9680e6dd5e9ae7f825fe7edab9fa35c119eb7feab0ab4e426c84a579daf4ef9"</span>,
  <span class="hljs-string">"source_pos"</span>: <span class="hljs-number">2</span>,
  <span class="hljs-string">"valid_height"</span>: <span class="hljs-number">0</span>
}
</code></pre>
<p>找到对应的合约UTXO之后，可以通过<a href="https://github.com/Bytom/bytom/wiki/API-Reference#decode-program">API接口<code>decode-program</code></a>解析合约的参数信息，用户可以根据已有的参数信息判断该合约能否解锁</p>
<hr>
<h3>解锁合约</h3>
<p><code>unlock</code>解锁合约，即调用合约，其本质是通过给交易添加相应的合约参数以便合约程序<code>program</code>在虚拟机中执行成功，目前合约相关的参数都可以通过<code>build-transaction</code>中的<code>Action</code>结构<code>spend_account_unspent_output</code>中的数组参数<code>arguments</code>进行添加，其中参数如下：</p>
<p>1） <code>RawTxSigArgument</code> 签名相关的参数，<code>type</code>类型为<code>raw_tx_signature</code>，主要包含主公钥<code>xpub</code>和其对应的派生路径<code>derivation_path</code>，而待验证的<code>publickey</code>是通过该主公钥和派生路径生成的子公钥生成的（这些参数可以通过API接口<code>list-pubkeys</code>获取）</p>
<ul>
<li><code>xpub</code> 主公钥</li>
<li><code>derivation_path</code> 派生路径</li>
</ul>
<p>参数格式如下：</p>
<pre><code class="language-js">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
  <span class="hljs-string">"raw_data"</span>: {
    <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
    <span class="hljs-string">"derivation_path"</span>: [
      <span class="hljs-string">"010100000000000000"</span>,
      <span class="hljs-string">"0100000000000000"</span>
    ]
  }
}
</code></pre>
<p>2） <code>DataArgument</code> 数据类型参数，<code>type</code>类型为<code>data</code>，该类型可以兼容除了<code>rawTxSigArgument</code>以外的所有合约参数类型，其值是16进制的字符串，需要注意的是<code>integer</code>整数类型是小端存储格式。参数格式如下：（以<code>publickey</code>为例）</p>
<pre><code class="language-js">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"data"</span>,
  <span class="hljs-string">"raw_data"</span>: {
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"b3f37834dfa74174e9f0d208302e77c637cfe66c3e37fe1e1574e416b3516e89"</span>
  }
}
</code></pre>
<p>3）<code>BoolArgument</code> 布尔类型参数，<code>type</code>类型为<code>boolean</code>，该类型取值为<code>true</code>或<code>false</code>。参数格式如下：</p>
<pre><code class="language-js">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"boolean"</span>,
  <span class="hljs-string">"raw_data"</span>: {
    <span class="hljs-string">"value"</span>: <span class="hljs-literal">true</span>
  }
}
</code></pre>
<p>4）<code>IntegerArgument</code> 整型类型参数，<code>type</code>类型为<code>integer</code>。参数格式如下：</p>
<pre><code class="language-js">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"integer"</span>,
  <span class="hljs-string">"raw_data"</span>: {
    <span class="hljs-string">"value"</span>: <span class="hljs-number">10000</span>
  }
}
</code></pre>
<p>5）<code>StrArgument</code> 字符串类型参数，<code>type</code>类型为<code>string</code>。参数格式如下：</p>
<pre><code class="language-js">{
  <span class="hljs-string">"type"</span>: <span class="hljs-string">"string"</span>,
  <span class="hljs-string">"raw_data"</span>: {
    <span class="hljs-string">"value"</span>: <span class="hljs-string">"this is a test string"</span>
  }
}
</code></pre>
<p>以合约<code>LockWithPublicKey</code>为例，其解锁合约交易的模板如下：</p>
<pre><code class="language-js"><span class="hljs-comment">// Request</span>
{
  <span class="hljs-string">"base_transaction"</span>: <span class="hljs-literal">null</span>,
  <span class="hljs-string">"actions"</span>: [
    {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"spend_account_unspent_output"</span>,
      <span class="hljs-string">"output_id"</span>: <span class="hljs-string">"413d941faf5a19501ab4c06747fe1eb38c5ae76b74d0f5af524fc40ee6bf7116"</span>,
      <span class="hljs-string">"arguments"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
          <span class="hljs-string">"raw_data"</span>: {
            <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
            <span class="hljs-string">"derivation_path"</span>: [
              <span class="hljs-string">"010100000000000000"</span>,
              <span class="hljs-string">"0100000000000000"</span>
            ]
          }
        }
      ]
    },
    {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"control_program"</span>,
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c22"</span>,
      <span class="hljs-string">"amount"</span>: <span class="hljs-number">900000000</span>,
      <span class="hljs-string">"control_program"</span>: <span class="hljs-string">"0014726e902e30525e01f0157f12be476c904060383b"</span>
    },
    {
      <span class="hljs-string">"type"</span>: <span class="hljs-string">"spend_account"</span>,
      <span class="hljs-string">"asset_id"</span>: <span class="hljs-string">"ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff"</span>,
      <span class="hljs-string">"amount"</span>: <span class="hljs-number">5000000</span>,
      <span class="hljs-string">"account_id"</span>: <span class="hljs-string">"0G1JIR6400A02"</span>
    }
  ],
  <span class="hljs-string">"ttl"</span>: <span class="hljs-number">0</span>,
  <span class="hljs-string">"time_range"</span>: <span class="hljs-number">1521625823</span>
}

<span class="hljs-comment">// Result</span>
{
  <span class="hljs-string">"raw_transaction"</span>: <span class="hljs-string">"0701dfd5c8d5050201720170c9680e6dd5e9ae7f825fe7edab9fa35c119eb7feab0ab4e426c84a579daf4ef91e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c2280d293ad0302012820e9108d3ca8049800727f6a3505b3a2710dc579405dde03c250f16d9a7e1e6e787403ae7cac00c001000160015e8412e8e8c359683f1f5f3a7308b084022f1f149dab176e6e6e8daada895d0e29ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0c6c6944f00011600141313e974d19f3d37db29a212d75b4c763e42f433010002013d1e074b22ed7ae8470c7ba5d8a7bc95e83431a753a17465e8673af68a82500c2280d293ad0301160014726e902e30525e01f0157f12be476c904060383b00013dffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffa0b095924f011600147076c737d92621e0033899a54d02fa79f362922700"</span>,
  <span class="hljs-string">"signing_instructions"</span>: [
    {
      <span class="hljs-string">"position"</span>: <span class="hljs-number">0</span>,
      <span class="hljs-string">"witness_components"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
          <span class="hljs-string">"quorum"</span>: <span class="hljs-number">1</span>,
          <span class="hljs-string">"keys"</span>: [
            {
              <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
              <span class="hljs-string">"derivation_path"</span>: [
                <span class="hljs-string">"010100000000000000"</span>,
                <span class="hljs-string">"0100000000000000"</span>
              ]
            }
          ],
          <span class="hljs-string">"signatures"</span>: <span class="hljs-literal">null</span>
        }
      ]
    },
    {
      <span class="hljs-string">"position"</span>: <span class="hljs-number">1</span>,
      <span class="hljs-string">"witness_components"</span>: [
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"raw_tx_signature"</span>,
          <span class="hljs-string">"quorum"</span>: <span class="hljs-number">1</span>,
          <span class="hljs-string">"keys"</span>: [
            {
              <span class="hljs-string">"xpub"</span>: <span class="hljs-string">"5c6145b241b1147987565719657a0506ebb417a2e110a235a42cfb40951880f447432f930ce9fd1a6b7e51b3ddbfdc7adb57d33448f93c0defb4de630703a144"</span>,
              <span class="hljs-string">"derivation_path"</span>: [
                <span class="hljs-string">"010100000000000000"</span>,
                <span class="hljs-string">"0300000000000000"</span>
              ]
            }
          ],
          <span class="hljs-string">"signatures"</span>: <span class="hljs-literal">null</span>
        },
        {
          <span class="hljs-string">"type"</span>: <span class="hljs-string">"data"</span>,
          <span class="hljs-string">"value"</span>: <span class="hljs-string">"c37d5531f393bc6a3568628c0c0e17801ea452e75d604deb01403c4b161659a3"</span>
        }
      ]
    }
  ],
  <span class="hljs-string">"allow_additional_actions"</span>: <span class="hljs-literal">false</span>
}
</code></pre>
<p>构建交易成功之后，便可以对交易进行签名<code>sign-transaction</code>，返回结果中<code>sign_complete</code>为<code>true</code>表示签名成功，将签名的交易通过<code>submit-transaction</code>提交到交易池中，等待交易被打包上链</p>
</div></section><footer class="footer-container"><div class="footer-body"><img src="/img/dubbo_gray.png"/><div class="cols-container"><div class="col col-12"><h3>友情提示</h3><p>如果文档编辑有错误，请联系我们!</p></div><div class="col col-6"><dl><dt>文档</dt><dd><a href="/zh-cn/docs/00_index.html" target="_self">Overview</a></dd><dd><a href="/zh-cn/docs/13_architecture_overview.html" target="_self">Quick start</a></dd><dd><a href="/zh-cn/docs/06_build_environment.html" target="_self">Developer guide</a></dd></dl></div><div class="col col-6"><dl><dt>编辑文档</dt><dd><a href="https://github.com/bytomlabs/bytomlabs.github.io" target="_self">Github</a></dd></dl></div></div><div class="copyright"><span>Copyright © 2018 Bytom</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>