<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
	<meta name="keywords" content="13_1_mining_pool_docking_guide" />
	<meta name="description" content="13_1_mining_pool_docking_guide" />
	<!-- 网页标签标题 -->
	<title>13_1_mining_pool_docking_guide</title>
	<link rel="shortcut icon" href="/img/docsite.ico"/>
	<link rel="stylesheet" href="/build/documentation.css" />
</head>
<body>
	<div id="root"><div class="documentation-page" data-reactroot=""><header class="header-container header-container-normal"><div class="header-body"><a href="/zh-cn/index.html"><img class="logo" src="/img/dubbo_colorful.png"/></a><span class="language-switch language-switch-normal">En</span><span class="github"><a title="Github" target="_blank" href="https://github.com/Bytom/bytom"><img src="/img/github.png" alt=""/></a></span><div class="header-menu"><img class="header-menu-toggle" src="/img/system/menu_gray.png"/><ul><li class="menu-item menu-item-normal"><a href="//bytom.io" target="_self">首页</a></li><li class="menu-item menu-item-normal"><a href="//bytom.io/dev" target="_self">开发者</a></li></ul></div></div></header><div style="background:url(/img/banner.png)  top center no-repeat" class="bar"><div class="bar-body"><p>比原链开发文档</p></div></div><section class="content-section"><div class="sidemenu"><div class="sidemenu-toggle"><img src="https://img.alicdn.com/tfs/TB1E6apXHGYBuNjy0FoXXciBFXa-200-200.png"/></div><ul><li class="menu-item menu-item-level-1"><span></span><ul><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/01_bytom.html" target="_self">比原链</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/02_release.html" target="_self">版本计划</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/03_technology.html" target="_self">技术介绍</a></li><li style="height:216px;overflow:hidden" class="menu-item menu-item-level-2"><span>客户端<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/04_1_bytom.html" target="_self">Bytomd</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/04_2_simd.html" target="_self">Simd</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/04_3_spv.html" target="_self">SPV</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/04_4_vapor.html" target="_self">Vapor</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/04_5_gm.html" target="_self">GM</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/05_compile.html" target="_self">编译钱包</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/06_network.html" target="_self">网络</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/07_dashboard.html" target="_self">仪表盘</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/08_cli_guide.html" target="_self">钱包命令</a></li><li style="height:216px;overflow:hidden" class="menu-item menu-item-level-2"><span>挖矿<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/09_1_tensority.html" target="_self">Tensority算法</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/09_2_cpu.html" target="_self">CPU挖矿</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/09_3_gpu.html" target="_self">GPU挖矿</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/09_4_asic.html" target="_self">ASIC矿机</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/09_5_mining_pools.html" target="_self">矿池挖矿</a></li></ul></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>工具<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/10_1_blockmeta.html" target="_self">Blockmeta</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/10_2_bytom_kit.html" target="_self">Bytom Kit</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/10_3_byone.html" target="_self">Byone</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/10_4_bytom_spanner.html" target="_self">Bytom Spanner</a></li></ul></li><li style="height:252px;overflow:hidden" class="menu-item menu-item-level-2"><span>开发指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/11_1_architecture.html" target="_self">系统架构</a></li><li class="menu-item menu-item-level-3"><a target="_self">交易说明</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/11_3_mnemonic.html" target="_self">助记词</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/11_4_websocket.html" target="_self">Websocket调用节点</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/11_5_json_rpc.html" target="_self">JSON-RPC调用</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/11_6_sdk.html" target="_self">SDK介绍</a></li></ul></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>智能合约<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/12_1_equity.html" target="_self">智能合约</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/12_2_smart_contract_build.html" target="_self">智能合约构建</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/12_3_contract_template.html" target="_self">智能合约模板</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/12_4_contract_operator.html" target="_self">智能合约操作码</a></li></ul></li><li style="height:72px;overflow:hidden" class="menu-item menu-item-level-2"><span>对接指南<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/13_1_mining_pool_docking_guide.html" target="_self">矿池对接文档</a></li></ul></li><li style="height:180px;overflow:hidden" class="menu-item menu-item-level-2"><span>术语表<img style="transform:rotate(0deg)" class="menu-toggle" src="/img/system/arrow_down.png"/></span><ul><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/14_1_transaction.html" target="_self">交易</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/14_2_address.html" target="_self">地址</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/14_3_account.html" target="_self">账户</a></li><li class="menu-item menu-item-level-3"><a href="/zh-cn/docs/14_4_block.html" target="_self">区块</a></li></ul></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/15_error_code.html" target="_self">错误码</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/16_faq.html" target="_self">常见问题</a></li><li style="height:36px;overflow:hidden" class="menu-item menu-item-level-2"><a href="/zh-cn/docs/17_community.html" target="_self">社区</a></li></ul></li></ul></div><div class="doc-content markdown-body"><h1>矿池对接文档</h1>
<p><a name="1172f2d3"></a></p>
<h2>矿机配置</h2>
<p><a href="https://gist.github.com/HAOYUatHZ/a47400bde4a138825faef415387b532c">https://gist.github.com/HAOYUatHZ/a47400bde4a138825faef415387b532c</a></p>
<p><a name="6f78a4be"></a></p>
<h2>固件升级</h2>
<p><a href="https://service.bitmain.com.cn/support">https://service.bitmain.com.cn/support</a></p>
<ul>
<li>两个都要刷,先后顺序没关系</li>
<li><em>update_1000.tar.gz</em> 升级时间较长，升级期间请勿断电</li>
</ul>
<p><a name="bb3098d6"></a></p>
<h2>配置节点</h2>
<ul>
<li>测试时可以考虑切换到 testnet 分支降低难度使cpu挖矿也能出块，<code>./bytomd init --chain_id testnet</code> 或 <code>./bytomd init --chain_id solonet</code></li>
<li><code>init</code>/<code>node</code> 初始化/启动时可以加上 <code>-r &quot;your/directory&quot;</code> 指定数据目录，若目录不存在则会自动新建该目录</li>
</ul>
<p><a name="f630b9a4"></a></p>
<h2>流程</h2>
<p>1、初始化节点先建个账户、地址，不然就挖到空地址</p>
<p>2、矿地址支持自定义，包括 非本地钱包地址</p>
<p>3、<a href="https://github.com/Bytom/bytom/wiki/API-Reference">API doc</a></p>
<p>4、矿池向节点 <a href="https://github.com/Bytom/bytom/wiki/API-Reference#get-work">getwork</a></p>
<p><code>get-work</code> 得到的 <code>block_header</code> 是动态压缩变长的需要进行解析</p>
<ul>
<li>使用 <em>golang</em> 的话可以利用 <code>&quot;github.com/bytom/protocol/bc/types&quot;</code> 中 <code>block_header.go</code> 中的函数 <code>UnmarshalText</code></li>
<li>使用别的语言的话参考 <code>&quot;github.com/bytom/protocol/bc/types&quot;</code> 中 <code>block.go</code> 中的函数 <code>UnmarshalText</code>, <code>readFrom</code>, <code>ReadVarintXXX</code>. <code>ReadVarintXXX</code> 需要参考 <a href="https://go.googlesource.com/go/+/go1.4.3/src/encoding/binary/varint.go">go函数 <code>binary.ReadUvarint</code></a></li>
</ul>
<p>5、解析完后进行下发</p>
<ul>
<li>通信格式参考 <a href="https://github.com/Bytom/B3-Mimic/blob/master/docs/STRATUM-BTM.md">https://github.com/Bytom/B3-Mimic/blob/master/docs/STRATUM-BTM.md</a> - 收到任务有 <code>login</code> 和 矿池主动下发, 没走 <code>getjob</code>, 只走 <code>login</code> 和 池主动下发 - 这俩都是用 <code>submit</code> 提交</li>
<li>逻辑参考 <a href="https://github.com/Bytom/B3-Mimic/blob/master/main.go">https://github.com/Bytom/B3-Mimic/blob/master/main.go</a> - <code>Version</code>, <code>Height</code>, <code>Timestamp</code>, <code>Bits</code> 要转小端 - 关于 <code>target</code> + <em>btc.com_antpool</em> 的代码 ~, 并说 <code>target</code> 用以对 <code>bits</code> 对应的 <code>difficulty</code> 放松难度，用来使矿机在单位时间内能够有提交，然后矿池再验证~</li>
</ul>
<pre><code>var Diff1 = StringToBig(&quot;0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF&quot;)

    func GetTargetHex(diff int64) string {
        padded := make([]byte, 32)
        diffBuff := new(big.Int).Div(Diff1, big.NewInt(diff)).Bytes()
        copy(padded[32-len(diffBuff):], diffBuff)
        buff := padded[0:4]
        targetHex := hex.EncodeToString(Reverse(buff))
        return targetHex
     }
</code></pre>
<ul>
<li>矿池下发的targethex是拿 标准难度（<code>0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF</code>） / 一个难度值得出的</li>
<li>这个值叫做矿池难度 一般会动态调整 保证矿机提交 share 的频率是稳定的 比如1分钟提交三次 提交得快了就会增加这个值 慢了就会降低这个值</li>
<li>target 是 16 进制的难度，1, 1024, …..等等，和前导 0 的个数有关，动态调整用来保证矿机每分钟至少提交三次，用来计算矿机算力以及防止矿机算力作弊 <code>ffff3f00</code> 对应 1024，<code>c5a70000</code> 对应 100001</li>
</ul>
<p>6、提交完之后矿池需要做验证</p>
<ul>
<li>header_hash 使用 golang 的话可以利用 <code>&quot;github.com/bytom/protocol/bc/types&quot;</code> 中 <code>types.BlockHeader{}</code> 的 <code>Hash()</code> 使用别的语言的话参考 <a href="https://github.com/Bytom/B3-Mimic/blob/master/docs/blhr_hash_V3.go">https://github.com/Bytom/B3-Mimic/blob/master/docs/blhr_hash_V3.go</a></li>
<li>然后就要开始用 tensority 算 hash 结果 很遗憾现在 go 版本、cpp_openblas 版本、cpp_simd 版本都达不到理想的验证效果, 如果想做一个可用的矿池目前有必要上 gpu, 可以考虑 n 卡 1050，或者阿里云服务器 P4</li>
</ul>
<blockquote>
<p>cpp 的 tensority 逻辑在<a href="https://github.com/Bytom/CppTensority">这里</a>，并指出了如何针对 gpu 进行优化的建议，这样矩阵乘法能够跑进 2.5 ms, 整个 tensority 大概 6 ms</p>
</blockquote>
<ul>
<li>init matlist 有开销，seed 其实 256 个区块才改变一次, 遇到新的 seed 每次 gpu tensority 可能需要 100 ms，但做了 cache 的话 init matlist 可以忽略，可以认为每次 tensority 只需要不超过 6 ms</li>
<li>用 golang 可以 cgo 调用 c 代码，参考 <a href="https://github.com/Bytom/bytom/blob/dev-ts-simd/mining/tensority/algorithm.go">https://github.com/Bytom/bytom/blob/dev-ts-simd/mining/tensority/algorithm.go</a></li>
<li>改好 gpu 版本后可以参照这个进行调用</li>
</ul>
<p>7、验证通过后使用 <a href="https://github.com/Bytom/bytom/wiki/API-Reference#submit-work">submit-work</a> 接口进行提交</p>
<p>提交的结果 也是 BlockHeader type 的</p>
<ul>
<li>使用 <em>golang</em> 的话可以利用 <code>&quot;github.com/bytom/protocol/bc/types&quot;</code> 中 <code>block_header.go</code> 中的函数 <code>MmarshalText</code></li>
<li>使用别的语言的话参考 <code>&quot;github.com/bytom/protocol/bc/types&quot;</code> 中 <code>block.go</code> 中的函数 <code>MarshalText</code>, <code>WriteTo</code>, <code>WriteVarintXXX</code>. <code>WriteVarintXXX</code> 需要参考 <a href="https://go.googlesource.com/go/+/go1.4.3/src/encoding/binary/varint.go">go函数 <code>binary.PutUvarint</code></a></li>
</ul>
<p>8、retarget</p>
<p>见上面，动态调整使矿机每分钟提交三次</p>
<p>9、收益计算</p>
<p>略</p>
<p><a name="cbd08f58"></a></p>
<h2>批量转账</h2>
<ul>
<li>主网地址 bm 开头，长度普通地址42，多签62 工具 <a href="https://github.com/Bytom/bytom/tree/master/tools/sendbulktx">https://github.com/Bytom/bytom/tree/master/tools/sendbulktx</a></li>
<li>每次发币都会生成新的找零地址</li>
<li>bytom input有21个的限制</li>
</ul>
</div></section><footer class="footer-container"><div class="footer-body"><div class="copyright"><span>Copyright © 2019 Bytom</span></div></div></footer></div></div>
	<script src="https://f.alicdn.com/react/15.4.1/react-with-addons.min.js"></script>
	<script src="https://f.alicdn.com/react/15.4.1/react-dom.min.js"></script>
	<script>
		window.rootPath = '';
  </script>
	<script src="/build/documentation.js"></script>
</body>
</html>